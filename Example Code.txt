const Discord = require('discord.js');
const yt = require('ytdl-core');
const bot = new Discord.Client();
const config = require("./config.json")

bot.on('ready', () => {
  console.log('I am ready!');
});

bot.on("guildMemberAdd", member => {
  let guild = member.guild;
  guild.defaultChannel.sendMessage(`Everybody, Welcome ${member.user} to the server`).catch(console.error);
});

bot.on("guildCreate", guild => {
  console.log(`New Guild added : ${guild.name}, owned by ${guild.owner.user.username}`);
});

bot.on('message', message => {
  if (message.content.startsWith('!play')) {
    const voiceChannel = message.member.voiceChannel;
    if (!voiceChannel) {
      return message.reply(`Please be in a voice channel first!`);
    }
    voiceChannel.join()
      .then(connnection => {
        let stream = yt("https://www.youtube.com/watch?v=dQw4w9WgXcQ", {audioonly: true});
        const dispatcher = connnection.playStream(stream);
        dispatcher.on('end', () => {
          voiceChannel.leave();
        });
      });
  }
});

  bot.on('message', message => {
  if(message.author.bot) return;
  if(!message.content.startsWith(config.prefix)) return;

  let command = message.content.split(" ")[0];
  command = command.slice(config.prefix.length);

  let args = message.content.split(" ").slice(1);

  if (command === "add") {
    let numArray = args.map(n=> parseInt(n));
    let total = numArray.reduce( (p, c) => p+c);

    message.channel.sendMessage(total).catch(console.error);
  }

  if (message.content.startsWith(prefix + "clear")) {
      let messagecount = parseInt(params[0]);
      message.channel.fetchMessages({limit: messagecount})
          .then(messages => message.channel.bulkDelete(messages));
  }
  if (command === "say") {
    message.channel.sendMessage(args.join(" ")).catch(console.error);
  }

  if (command === "Commands") {
  message.author.sendMessage("coming soon, wait");
  } else

  if (command === "rawr") {
    message.reply('ok, shut the fuck up faggot...').catch(console.error);
  } else

  if (command === "awake") {
    message.channel.sendMessage('im still awake!').catch(console.error);
  } else

  if (command === "ping") {
    let modRole = message.guild.roles.find("name", "admin");
    if(message.member.roles.has(modRole.id)) {
      message.channel.sendMessage('pong!').catch(console.error);
    } else {
      message.reply("You don't have permission to use this command, sorry.").catch(console.error);
    }
  }

  if (command === "kick") {
    let modRole = message.guild.roles.find("name", "admin");
    if(!message.member.roles.has(modRole.id)) {
      return message.reply("You don't have permission to use this command, sorry.");
    }
    if(message.mentions.users.size === 0) {
      return message.reply("Please mention a user to kick, silly!");
    }
    let kickMember = message.guild.member(message.mentions.users.first());
    if(!kickMember) {
      return message.reply("That user doesn't exist...");
    }
    if(!message.guild.member(bot.user).hasPermission("KICK_MEMBERS")) {
      return message.reply("I don't have the permissions (KICK_MEMBER) to do this.");
    }
    kickMember.kick().then(member =>{
      message.reply(`${member.user.username} was successfully kicked. `).catch(console.error);
    }).catch(console.error)
  }

});

bot.login(config.token);
